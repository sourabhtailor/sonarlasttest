name: CI - SonarCloud Quality Check with Revert

on:
  push:
    branches:
      - dev

concurrency:
  group: revert-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sonar-quality-check:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the pushed code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 3: Run SonarCloud Scan
      - name: SonarCloud Scan
        id: sonar
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          args: >
            -Dsonar.projectKey=sourabhtailor_sonarcloud-aws
            -Dsonar.organization=sourabhtailor
            -Dsonar.sources=.
            -Dsonar.exclusions=vendor/**,tests/**,.github/**
            -Dsonar.projectVersion=v1.0.${{ github.run_number }}
            -Dsonar.qualitygate.wait=true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # Step 4: If Quality Gate fails, revert and push
      - name: Revert commit if Sonar fails
        if: failure()  # Only runs if Sonar step fails
        run: |
          echo "Sonar Quality Gate failed. Reverting commit..."

          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

          git fetch origin
          git checkout dev
          git pull origin dev

          git revert --no-edit ${{ github.event.after }}

          echo "Pushing revert to origin/dev..."

          for i in {1..3}; do
            git pull origin dev && git push origin dev && break || sleep 3
          done
